import unittest

import networkx as nx

import dataflow.reaching_definitions as rd
import dataflow.def_use as du
from itertools import filterfalse
import util.misc as um


class TestDefinitionUsePairs(unittest.TestCase):

    def test_def_use_pairs(self):
        sample_function = nx.max_weight_matching

        cfg: nx.DiGraph = du.try_create_cfg_with_definitions_and_uses(sample_function)
        pairs = rd.definition_use_pairs(cfg)

        # for b in um.grouper_it(7, pairs):
        #     print(", ".join([str((p.definition.line, p.use.line)) for p in b])+", ")

        pairs_expected = [
            (255, 256), (255, 257), (255, 257), (256, 257), (258, 257), (253, 257), (256, 258),
            (260, 259), (254, 259), (256, 259), (258, 316), (253, 316), (724, 725), (735, 736),
            (735, 736), (735, 737), (791, 752), (740, 752), (755, 756), (755, 759), (759, 760),
            (755, 760), (755, 763), (759, 764), (763, 765), (764, 765), (755, 768), (759, 768),
            (755, 769), (759, 769), (769, 770), (755, 772), (759, 772), (759, 772), (755, 772),
            (755, 773), (759, 773), (764, 774), (759, 777), (755, 777), (764, 778), (362, 782),
            (755, 782), (759, 782), (782, 783), (399, 786), (782, 786), (755, 786), (759, 786),
            (634, 790), (755, 790), (759, 790), (759, 793), (764, 798), (759, 799), (755, 800),
            (759, 800), (759, 800), (764, 801), (763, 804), (769, 805), (846, 805), (763, 805),
            (755, 806), (759, 806), (763, 806), (759, 807), (759, 811), (769, 812), (846, 812),
            (759, 812), (755, 813), (759, 813), (759, 813), (791, 815), (740, 815), (832, 833),
            (832, 834), (832, 835), (822, 836), (827, 836), (838, 836), (835, 836), (823, 836),
            (837, 836), (828, 836), (835, 837), (832, 839), (843, 844), (843, 844), (843, 845),
            (843, 846), (260, 847), (254, 847), (846, 848), (846, 849), (846, 851), (854, 852),
            (822, 852), (838, 852), (827, 852), (849, 852), (851, 852), (823, 852), (853, 852),
            (837, 852), (828, 852), (849, 853), (851, 853), (843, 855), (858, 859), (858, 859),
            (854, 860), (822, 860), (827, 860), (862, 860), (838, 860), (858, 860), (823, 860),
            (853, 860), (837, 860), (828, 860), (861, 860), (858, 861), (858, 863), (854, 865),
            (822, 865), (862, 865), (838, 865), (827, 865), (874, 875), (874, 877), (823, 877),
            (853, 877), (837, 877), (828, 877), (861, 877), (871, 877), (874, 878), (874, 880),
            (823, 880), (853, 880), (837, 880), (828, 880), (861, 880), (871, 880), (881, 882),
            (881, 883), (881, 885), (823, 885), (853, 885), (837, 885), (828, 885), (861, 885),
            (871, 885), (881, 886), (881, 888), (823, 888), (853, 888), (837, 888), (828, 888),
            (861, 888), (871, 888), (854, 891), (822, 891), (862, 891), (870, 891), (838, 891),
            (827, 891), (854, 894), (822, 894), (827, 894), (862, 894), (870, 894), (838, 894),
            (839, 896), (855, 896), (823, 896), (896, 897), (896, 898), (896, 898), (896, 898),
            (896, 898), (896, 899), (854, 900), (822, 900), (827, 900), (862, 900), (870, 900),
            (838, 900), (839, 902), (855, 902), (823, 902), (902, 903), (902, 903), (902, 903),
            (902, 903), (902, 904), (902, 905), (854, 906), (822, 906), (827, 906), (862, 906),
            (870, 906), (838, 906), (863, 908), (823, 908), (913, 914), (913, 914), (791, 917),
            (740, 917), (921, 922), (921, 924), (921, 924), (921, 925), (921, 926), (260, 929),
            (254, 929), (667, 930),
        ]

        self.assertEqual(len(pairs), len(pairs_expected))

        def determine(el):
            for pair in pairs:
                if pair.definition.line == el[0] and pair.use.line == el[1]:
                    return True
            return False

        not_found_pairs = list(filterfalse(determine, pairs_expected))
        self.assertEqual(0, len(not_found_pairs))
